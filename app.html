<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pedidos | Plataforma</title>
  <link rel="icon" href="logo.png">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    :root{--azul:#003366;--azul-2:#001122;--azul-3:#004080;--amarillo:#ffcc00;--gris-borde:#ccc;--bg:#f8f9fa;--text:#333;--card:#fff;--card-hover:#f1f1f1;--resumen-bg:#fff3cd;--resumen-borde:#ffeeba;--ok:#16a34a;--error:#dc2626;--shadow:0 10px 24px rgba(0,0,0,.18);}
    *{box-sizing:border-box;margin:0;padding:0} body{font-family:'Roboto',sans-serif;background:var(--bg);color:var(--text)}
    header{background:linear-gradient(90deg,var(--azul) 0%,var(--azul-2) 100%);color:#fff;text-align:center;padding:1.2rem 1rem}
    header img{max-height:140px;margin:0 auto .6rem}
    main{padding:1rem 1rem 112px;max-width:900px;margin:auto}
    .tabs{display:flex;justify-content:center;gap:1rem;flex-wrap:wrap;margin-bottom:1rem}
    .tabs button{padding:.8rem 1.8rem;font-size:1.1rem;border:none;border-radius:30px;background:var(--azul-3);color:var(--amarillo);font-weight:bold;box-shadow:0 3px 8px rgba(0,0,0,.2);cursor:pointer;transition:.3s;border:2px solid transparent}
    .tabs button.active{background:var(--azul-2);border-color:var(--amarillo);box-shadow:0 4px 12px rgba(0,0,0,.3)}
    details{border:1px solid var(--gris-borde);border-radius:8px;margin-bottom:1rem;overflow:hidden;background:var(--card)}
    summary{background:var(--azul);color:var(--amarillo);padding:1rem;cursor:pointer;font-weight:bold;font-size:1.1rem;user-select:none;list-style:none}
    .producto{display:grid;grid-template-columns:64px 1fr auto;align-items:center;gap:.9rem;padding:.7rem 1rem;border-top:1px solid #ddd;background:var(--card)}
    .producto:hover{background:var(--card-hover)}
    .prod-thumb{width:64px;height:64px;border-radius:10px;overflow:hidden;background:#eef2f7;display:grid;place-items:center;border:1px solid #e5e7eb}
    .prod-thumb img{width:100%;height:100%;object-fit:cover}
    .producto h3{margin:.2rem 0;color:#004c99;font-size:1rem}
    .contador{display:flex;align-items:center;gap:.5rem}
    .contador button{background:var(--azul);color:var(--amarillo);border:none;padding:.3rem .6rem;font-weight:bold;font-size:1.2rem;cursor:pointer;border-radius:5px}
    #resumen{background:var(--resumen-bg);border:1px solid var(--resumen-borde);border-radius:8px;padding:1rem}
    .toast-wrap{position:fixed;left:50%;bottom:84px;transform:translateX(-50%);z-index:200;display:flex;flex-direction:column;gap:.5rem;pointer-events:none}
    .toast{pointer-events:auto;background:#0b1f3a;color:#fff;border-left:4px solid var(--azul-3);padding:.7rem 1rem;border-radius:8px;box-shadow:0 10px 24px rgba(0,0,0,.25)}
    .cart-fab{position:fixed;right:16px;bottom:calc(18px + env(safe-area-inset-bottom));z-index:99;background:var(--azul);color:var(--amarillo);border:2px solid var(--amarillo);display:flex;align-items:center;gap:.6rem;padding:.7rem 1.1rem;border-radius:9999px;font-size:1.05rem;box-shadow:0 8px 20px rgba(0,0,0,.25);cursor:pointer}
  </style>
</head>
<body>
  <header>
    <img id="localLogo" src="logo.png" alt="Logo">
    <h1 id="localNombre">Mi Local</h1>
    <p id="localSlogan">¬°Hac√© tu pedido desde la web!</p>
  </header>

  <main>
    <div class="tabs">
      <button id="btn-rotiseria" class="active" onclick="mostrar('rotiseria')">üçï Rotiser√≠a</button>
      <button id="btn-bebidas"  onclick="mostrar('bebidas')">ü•§ Bebidas</button>
    </div>
    <div id="menu-rotiseria"></div>
    <div id="menu-bebidas" style="display:none"></div>

    <section id="checkout">
      <label>Nombre:<input type="text" id="nombre" placeholder="Tu nombre"></label>
      <label>Direcci√≥n:<input type="text" id="direccion" placeholder="Calle, n√∫mero, piso/depto"></label>
      <div id="resumen">
        <h3>Resumen del pedido</h3>
        <p id="emptyMsg" class="resumen-empty">A√∫n no agregaste productos.</p>
        <ul id="lista" class="resumen-list"></ul>
        <div class="totales" aria-live="polite">
          <div class="tot-line"><span>Subtotal</span><span id="subtotal">$ 0</span></div>
          <div id="envioLine" class="tot-line" hidden><span>Env√≠o</span><span id="envioCosto"></span></div>
          <div class="tot-line total"><span>Total</span><span id="total">$ 0</span></div>
        </div>
        <div class="acciones">
          <button id="btn-whatsapp" onclick="enviarPedido()">Hacer pedido por WhatsApp</button>
          <button id="btn-vaciar"   type="button" onclick="vaciarCarrito()">Vaciar carrito</button>
        </div>
      </div>
    </section>
  </main>

  <button id="cartFab" type="button" class="cart-fab" hidden>
    <span>üõí</span><span id="fabTotal">$ 0</span><span id="fabCount">0</span>
  </button>

  <div id="toastWrap" class="toast-wrap"></div>

<script>
// ====== helpers carga por slug ======
const params = new URLSearchParams(location.search);
const SLUG = params.get('l') || 'demo';
const baseData = `data/locales/${SLUG}`;
const asset = (p) => (location.hostname.endsWith('github.io') ? `/${location.pathname.split('/').filter(Boolean)[0]}/${p}` : `/${p}`);

// ====== TTL storage 2h ======
function setWithTTL(key, value, ttlMs){ localStorage.setItem(key, JSON.stringify({v:value, exp:Date.now()+ttlMs})); }
function getWithTTL(key, fallback){ try{ const raw = JSON.parse(localStorage.getItem(key)); if(!raw) return fallback; if(raw.exp && Date.now()>raw.exp){ localStorage.removeItem(key); return fallback; } return (raw.v===undefined?fallback:raw.v); }catch{ return fallback; } }
function isExpired(key){ try{ const raw=JSON.parse(localStorage.getItem(key)); return !!(raw && raw.exp && Date.now()>raw.exp); }catch{return false;} }

const CART_TTL_MS=2*60*60*1000, CLIENT_TTL_MS=2*60*60*1000;
const CART_KEY  =`tachi_cart_${SLUG}`;
const CLIENT_KEY=`tachi_client_${SLUG}`;
const loadCart   = () => getWithTTL(CART_KEY, {});
const saveCart   = (obj) => setWithTTL(CART_KEY, obj,   CART_TTL_MS);
const loadClient = () => getWithTTL(CLIENT_KEY, {});
const saveClient = (obj) => setWithTTL(CLIENT_KEY, obj, CLIENT_TTL_MS);

let HORARIOS={rotiseria:{dias:[0,1,2,3,4,5,6],rangos:[{desde:'00:00',hasta:'23:59'}]},bebidas:{dias:[0,1,2,3,4,5,6],rangos:[{desde:'00:00',hasta:'23:59'}]}}, 
    SECCIONES_CERRADAS={rotiseria:false,bebidas:false}, CIERRE_MSGS={rotiseria:'',bebidas:''}, SHIPPING=1000, WSP_NUMBER='3415923882';

const cantidades={}, listaEl=document.getElementById('lista'),
      subtotalEl=document.getElementById('subtotal'), totalEl=document.getElementById('total'),
      envioLineEl=document.getElementById('envioLine'), envioCostoEl=document.getElementById('envioCosto'),
      emptyMsg=document.getElementById('emptyMsg'), btnWA=document.getElementById('btn-whatsapp'),
      nombreEl=document.getElementById('nombre');

const fab=document.getElementById('cartFab'), fabCount=document.getElementById('fabCount'), fabTotal=document.getElementById('fabTotal');
let sheetOpen=false;

function formatARS(n){return new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(n);}
function showToast(msg,type='ok',t=2000){const wrap=document.getElementById('toastWrap');const el=document.createElement('div');el.className='toast';el.textContent=msg;wrap.appendChild(el);setTimeout(()=>{el.style.opacity='0';el.style.transition='opacity .2s'},t);setTimeout(()=>wrap.removeChild(el),t+220);}

function hmToMin(hm){const [h,m]=hm.split(':').map(Number);return h*60+(m||0)}
function ahoraMin(){const n=new Date();return n.getHours()*60+n.getMinutes()}
function hoyDia(){return new Date().getDay()}
function estaAbierto(seccion){ if(SECCIONES_CERRADAS[seccion]) return false; const cfg=HORARIOS[seccion]; if(!cfg) return true; if(!cfg.dias.includes(hoyDia())) return false; const now=ahoraMin(); return cfg.rangos.some(r=>now>=hmToMin(r.desde)&&now<=hmToMin(r.hasta)); }
function seccionDeId(id){ return id.includes('bebidas')?'bebidas':'rotiseria'; }

function normalizar(d){ return Array.isArray(d?.categorias) ? Object.fromEntries(d.categorias.map(c=>[c.categoria,c.productos||[]])) : {}; }

function renderProductos(contId,data){
  const cont=document.getElementById(contId);cont.innerHTML='';
  const norm=normalizar(data);
  for(const cat in norm){
    const items=norm[cat]||[];const det=document.createElement('details');const sum=document.createElement('summary');sum.textContent=cat;det.appendChild(sum);
    items.forEach((prod,i)=>{
      const id=`${contId}-${cat}-${i}`; if(!(id in cantidades))cantidades[id]=0;
      const div=document.createElement('div');div.className='producto';
      const thumb = prod.img ? asset(prod.img) : 'logo.png';
      div.innerHTML=`
        <div class="prod-thumb"><img src="${thumb}" alt="${prod.nombre}"></div>
        <div class="producto-info">
          <h3>${prod.nombre}</h3>
          ${prod.desc?`<p>${prod.desc}</p>`:''}
          <div class="price-wrap"><span class="price-new">${formatARS(prod.precio)}</span></div>
        </div>
        <div class="contador">
          <button onclick="cambiarCantidad('${id}',-1,this)">‚àí</button>
          <span id="cantidad-${id}">0</span>
          <button onclick="cambiarCantidad('${id}',1,this)">+</button>
        </div>`;
      div.dataset.nombre=prod.nombre;div.dataset.precio=prod.precio;det.appendChild(div);
    });
    cont.appendChild(det);
  }
}

function cambiarCantidad(id,delta,btn){
  const sec = seccionDeId(id);
  if(delta > 0 && !estaAbierto(sec)){ showToast('Secci√≥n cerrada'); return; }
  cantidades[id]=Math.max(0,(cantidades[id]||0)+delta);
  const span=document.getElementById(`cantidad-${id}`); if(span) span.textContent=cantidades[id];
  saveCart(cantidades); actualizarResumen();
}
function countItems(){ return Object.values(cantidades).reduce((a,b)=>a+(b||0),0); }
function setFabVisible(v){ if(!fab)return; if(v){ fab.removeAttribute('hidden'); } else { fab.setAttribute('hidden',''); } }
function actualizarResumen(){
  listaEl.innerHTML=''; let subtotal=0, count=0;
  for(const id in cantidades){
    const qty=cantidades[id]; if(qty<=0) continue;
    const span=document.getElementById(`cantidad-${id}`); if(!span) continue;
    const row=span.closest('.producto'); const name=row?.dataset?.nombre; const price=parseInt(row?.dataset?.precio||0,10);
    const li=document.createElement('li'); li.innerHTML=`<span class="resumen-name">${name||'-'}</span> x${qty} <strong style="float:right">${formatARS(price*qty)}</strong>`; 
    listaEl.appendChild(li); subtotal+=price*qty; count+=qty;
  }
  subtotalEl.textContent=formatARS(subtotal);
  totalEl.textContent=formatARS(subtotal);
  fabCount.textContent=count; fabTotal.textContent=formatARS(subtotal);
  setFabVisible(count>0);
  btnWA.disabled = !(count>0 && nombreEl.value.trim().length>0);
}
function mostrar(sec){
  document.getElementById('menu-rotiseria').style.display = (sec==='rotiseria')?'block':'none';
  document.getElementById('menu-bebidas').style.display    = (sec==='bebidas')?'block':'none';
  document.getElementById('btn-rotiseria').classList.toggle('active', sec==='rotiseria');
  document.getElementById('btn-bebidas').classList.toggle('active', sec==='bebidas');
}
function enviarPedido(){
  const name=nombreEl.value.trim();
  if(!name){ showToast('Ingres√° tu nombre', 'error'); return; }
  if(countItems()===0){ showToast('Seleccion√° productos', 'error'); return; }
  let msg=`Hola, soy ${name}. Quiero hacer un pedido a ${document.getElementById('localNombre').textContent}:\n`;
  Object.entries(cantidades).forEach(([id,qty])=>{
    if(qty>0){
      const span=document.getElementById(`cantidad-${id}`); if(!span) return;
      const row=span.closest('.producto'); const n=row.dataset.nombre; const p=parseInt(row.dataset.precio,10);
      msg+=`- ${n} x${qty} - ${formatARS(p*qty)}\n`;
    }
  });
  msg+=`Total: ${document.getElementById('total').textContent}`;
  window.open(`https://wa.me/${WSP_NUMBER}?text=${encodeURIComponent(msg)}`,'_blank');
}

// hydrate
function hydrateCart(){ Object.entries(loadCart()).forEach(([id,q])=>{ if(q>0){cantidades[id]=q; const el=document.getElementById(`cantidad-${id}`); if(el) el.textContent=q; }}); }
function hydrateClient(){ const c=loadClient(); if(c.name)nombreEl.value=c.name; if(c.address)document.getElementById('direccion').value=c.address; }
nombreEl.addEventListener('input',()=>{ saveClient({...loadClient(),name:nombreEl.value.trim()}); actualizarResumen(); });

async function boot(){
  // limpiar expirado
  if(isExpired(CART_KEY)) localStorage.removeItem(CART_KEY);
  if(isExpired(CLIENT_KEY)) localStorage.removeItem(CLIENT_KEY);

  // cargar ajustes del local y branding
  const aj = await fetch(`${baseData}/ajustes.json`).then(r=>r.json()).catch(()=>({whatsapp:'',shipping:1000,brand:{}}));
  WSP_NUMBER = String(aj.whatsapp||'').replace(/\D/g,'') || '3415923882';
  SHIPPING = Number(aj.shipping||1000);
  const brand = aj.brand || {};
  if(brand.nombre) document.getElementById('localNombre').textContent = brand.nombre;
  if(brand.slogan) document.getElementById('localSlogan').textContent = brand.slogan;
  if(brand.logo) document.getElementById('localLogo').src = brand.logo;

  const r = await fetch(`${baseData}/productos-rotiseria.json`).then(r=>r.json()).catch(()=>({categorias:[]}));
  const b = await fetch(`${baseData}/productos-bebidas.json`).then(r=>r.json()).catch(()=>({categorias:[]}));
  renderProductos('menu-rotiseria', r);
  renderProductos('menu-bebidas', b);
  hydrateCart(); hydrateClient(); actualizarResumen();
}
boot();
</script>
</body>
</html>
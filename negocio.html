<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Negocio</title>
  <link rel="icon" href="assets/logo.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#f4f6fa;--card:#fff;--line:#e5e7eb;--text:#0f172a;--muted:#475569;--brand:#0b376d;--brand2:#062247;--accent:#ffcc00;}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,sans-serif}
    a{color:inherit}
    .h{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;padding:22px 16px}
    .hwrap{max-width:980px;margin:0 auto;display:flex;gap:14px;align-items:center}
    .logo{width:56px;height:56px;border-radius:14px;border:1px solid rgba(255,255,255,.2);background:#001b36;display:grid;place-items:center}
    .title{font-size:32px;font-weight:800} .sub{opacity:.9}
    .back{display:inline-block;margin-bottom:8px;color:#fff}
    main{max-width:980px;margin:14px auto 120px;padding:0 16px}
    /* chips removed per request */
    details.cat{background:var(--card);border:1px solid var(--line);border-radius:16px;margin:12px 0;overflow:hidden}
    summary{list-style:none;padding:16px 18px;font-weight:800;background:#0f2342;color:#fff;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
    summary::-webkit-details-marker{display:none}
    .items{padding:8px}
    .row{display:grid;grid-template-columns:64px 1fr auto;gap:12px;align-items:center;border-top:1px solid var(--line);padding:12px 10px}
    .thumb{width:64px;height:64px;border-radius:12px;overflow:hidden;border:1px solid var(--line);background:#eef2f7}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .rname{font-weight:800} .rdesc{font-size:13px;color:var(--muted)} .rprice{font-weight:800;margin-top:4px}
    .ctr{display:flex;gap:8px;align-items:center}
    .ctr button{width:36px;height:36px;border-radius:10px;border:2px solid #14365f;background:#fff;font-weight:800;font-size:18px;cursor:pointer}
    .fab{position:fixed;right:16px;bottom:16px;background:#14365f;color:#fff;border:2px solid var(--accent);display:flex;gap:10px;align-items:center;padding:12px 16px;border-radius:999px;box-shadow:0 14px 28px rgba(2,6,23,.24);font-weight:800}
    .sheetBG{position:fixed;inset:0;background:rgba(0,0,0,.4);opacity:0;pointer-events:none;transition:.2s;z-index:40}
    .sheet{position:fixed;left:50%;right:auto;bottom:0;transform:translate(-50%,110%);width:min(760px,94vw);max-height:88vh;background:var(--card);border-radius:18px 18px 0 0;box-shadow:0 -16px 40px rgba(2,6,23,.24);transition:.28s;z-index:41;display:grid;grid-template-rows:auto 1fr}
    .sheet.open{transform:translate(-50%,0)} .sheetBG.open{opacity:1;pointer-events:auto}
    .shead{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:10px 14px 8px}
    .sbody{overflow:auto;padding:12px 14px 18px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:end}
    label{font-weight:800;font-size:14px;display:block} input[type=text]{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;outline:none}
    .seg{display:flex;gap:10px;margin:6px 0} .seg input{display:none}
    .seg label{flex:1;text-align:center;padding:10px;border:1px solid var(--line);border-radius:12px;cursor:pointer;font-weight:800;background:#fff}
    .seg input:checked + label{background:#14365f;color:#fff;border-color:#14365f}
    .tot{background:#fff8d2;border:1px solid #ffe08a;padding:10px;border-radius:12px;margin-top:10px}
    .tot .line{display:flex;justify-content:space-between;margin:4px 0} .btnrow{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
    .btn{background:#14365f;color:#fff;font-weight:800;border:none;border-radius:12px;padding:12px 16px;cursor:pointer}
    .btn.alt{background:#fff;border:1px solid var(--line);color:#14365f}
    .note{font-size:13px;color:#0b4b37;margin-top:4px}
  </style>
</head>
<body>
  <div class="h">
    <div class="hwrap">
      <a class="back" href="index.html">‚Üê Volver</a>
    </div>
    <div class="hwrap">
      <div class="logo"><img id="logo" src="assets/logo.svg" alt="" style="width:40px;height:40px"></div>
      <div>
        <div id="title" class="title">Negocio</div>
        <div id="sub" class="sub">Subt√≠tulo</div>
      </div>
    </div>
  </div>

  <main>
    <div id="cats"></div>
  </main>

  <button id="fab" class="fab" style="display:none">üõí <span id="fabTotal">$ 0</span> <span id="fabCount" style="background:#ffcc00;color:#001122;border-radius:999px;padding:2px 8px">0</span></button>

  <div id="sheetBG" class="sheetBG"></div>
  <div id="sheet" class="sheet" role="dialog" aria-modal="true">
    <div class="shead"><strong>Tu pedido</strong></div>
    <div class="sbody">
      <div class="seg">
        <input id="optRet" name="env" type="radio" value="retiro" checked><label for="optRet">Retiro</label>
        <input id="optEnv" name="env" type="radio" value="envio"><label for="optEnv">Env√≠o</label>
      </div>
      <div class="grid2">
        <div><label>Nombre<input id="inNombre" type="text" placeholder="Tu nombre"></label></div>
        <div id="addrWrap" style="display:none"><label>Direcci√≥n<input id="inDir" type="text" placeholder="Calle, n√∫mero, piso/depto"></label></div>
      </div>
      <div style="display:flex;gap:10px;margin-top:8px">
        <div style="flex:1"><label>Nota (opcional)<input id="inNota" type="text" placeholder="Sin sal, dejar en porter√≠a‚Ä¶"></label></div>
      </div>
      <div style="display:flex;gap:10px;margin-top:8px">
        <div><label>Propina %<input id="inProp" type="text" placeholder="0"></label></div>
        <div><label>Cup√≥n<input id="inCupon" type="text" placeholder="Ej: OFF10"></label></div>
      </div>

      <div class="tot">
        <div id="resumenItems" class="note">A√∫n no agregaste productos.</div>
        <div class="line"><span>Subtotal</span><strong id="totSub">$ 0</strong></div>
        <div class="line"><span>Env√≠o</span><strong id="totEnv">$ 0</strong></div>
        <div class="line"><span>Descuento</span><strong id="totDesc">$ 0</strong></div>
        <div class="line"><span>Propina</span><strong id="totTip">$ 0</strong></div>
        <div class="line" style="border-top:1px dashed #e5bd4a;margin-top:6px;padding-top:6px"><span>Total</span><strong id="totTotal">$ 0</strong></div>
      </div>

      <div class="btnrow">
        <button id="btnWsp" class="btn">Hacer pedido por WhatsApp</button>
        <button id="btnVaciar" class="btn alt">Vaciar carrito</button>
      </div>
    </div>
  </div>

  <script>
    const fmt = n => new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(n||0);
    async function loadJSON(u){ try{ const r=await fetch(u,{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status); return await r.json(); } catch(e){ console.error('loadJSON',u,e); return null; } }
    function qs(p){ return new URLSearchParams(location.search).get(p)||''; }
    function createRow(catIdx, pIdx, p){
      const id = catIdx+'-'+pIdx;
      const div = document.createElement('div'); div.className='row';
      div.innerHTML = '<div class="thumb"><img src="'+(p.img||'assets/placeholder.svg')+'" alt=""></div>'+
        '<div><div class="rname">'+p.nombre+'</div>'+(p.desc?'<div class="rdesc">'+p.desc+'</div>':'')+'<div class="rprice">'+fmt(p.precio)+'</div></div>'+
        '<div class="ctr"><button data-id="'+id+'" data-d="-1">‚àí</button><span id="q-'+id+'">0</span><button data-id="'+id+'" data-d="1">+</button></div>';
      div.dataset.nombre=p.nombre; div.dataset.precio=p.precio;
      return div;
    }
    const state = { counts:{}, shipping:0, wsp:'', nombre:'', dir:'', items:[], categorias:[] };
    function updateFab(){
      let count=0, total=0;
      Object.keys(state.counts).forEach(k=>{ const [ci,pi]=k.split('-').map(Number); const prod = state.categorias[ci].productos[pi]; const q=state.counts[k]||0; count+=q; total += q*(prod.precio||0); });
      document.getElementById('fabCount').textContent = count;
      document.getElementById('fabTotal').textContent = fmt(total + (document.querySelector('input[name=env]:checked')?.value==='envio'?state.shipping:0));
      document.getElementById('fab').style.display = count>0 ? 'flex' : 'none';
      renderResumen();
    }
    function renderResumen(){
      const resumen = document.getElementById('resumenItems');
      let sub=0; const lines=[];
      Object.keys(state.counts).forEach(k=>{ const [ci,pi]=k.split('-').map(Number); const q=state.counts[k]||0; if(!q) return; const p=state.categorias[ci].productos[pi]; sub += q*p.precio; lines.push(p.nombre+' x'+q+' - '+fmt(q*p.precio)); });
      resumen.textContent = lines.length? lines.join(' ‚Ä¢ ') : 'A√∫n no agregaste productos.';
      document.getElementById('totSub').textContent = fmt(sub);
      const envioSel = document.querySelector('input[name=env]:checked')?.value==='envio';
      document.getElementById('addrWrap').style.display = envioSel ? '' : 'none';
      const envio = envioSel ? (state.shipping||0) : 0;
      document.getElementById('totEnv').textContent = fmt(envio);
      const tipPct = Number((document.getElementById('inProp').value||'').replace(',','.'))||0;
      const tip = Math.max(0, Math.round(sub*tipPct/100));
      document.getElementById('totTip').textContent = fmt(tip);
      const cupon = (document.getElementById('inCupon').value||'').trim().toUpperCase();
      const desc = cupon==='OFF10' ? Math.round(sub*0.10) : 0;
      document.getElementById('totDesc').textContent = fmt(desc);
      const total=sub+envio+tip-desc;
      document.getElementById('totTotal').textContent = fmt(total);
      state._lastTotals = {sub,envio,tip,desc,total};
    }
    function openSheet(){ document.getElementById('sheet').classList.add('open'); document.getElementById('sheetBG').classList.add('open'); }
    function closeSheet(){ document.getElementById('sheet').classList.remove('open'); document.getElementById('sheetBG').classList.remove('open'); }
    document.getElementById('fab').addEventListener('click',openSheet); document.getElementById('sheetBG').addEventListener('click',closeSheet);
    document.getElementById('inProp').addEventListener('input',renderResumen); document.getElementById('inCupon').addEventListener('input',renderResumen);
    document.querySelectorAll('input[name=env]').forEach(r=>r.addEventListener('change',renderResumen));
    document.getElementById('btnVaciar').addEventListener('click',()=>{ state.counts={}; document.querySelectorAll('[id^="q-"]').forEach(s=>s.textContent='0'); updateFab(); });
    document.getElementById('btnWsp').addEventListener('click',()=>{
      const nombre=(document.getElementById('inNombre').value||'').trim(); if(!nombre){ alert('Ingres√° tu nombre'); return; }
      const envioSel = document.querySelector('input[name=env]:checked')?.value==='envio';
      if(envioSel && !(document.getElementById('inDir').value||'').trim()){ alert('Ingres√° tu direcci√≥n'); return; }
      const lines=[];
      Object.keys(state.counts).forEach(k=>{ const [ci,pi]=k.split('-').map(Number); const q=state.counts[k]||0; if(!q) return; const p=state.categorias[ci].productos[pi]; lines.push(`- ${p.nombre} x${q} - ${fmt(q*p.precio)}`); });
      const nota=(document.getElementById('inNota').value||'').trim(); const t=state._lastTotals||{sub:0,envio:0,tip:0,desc:0,total:0};
      let msg=`Hola, soy ${nombre}. Quiero hacer un pedido:%0A`+lines.join('%0A')+`%0A%0ASubtotal: ${fmt(t.sub)}%0A`;
      if(t.desc) msg+=`Descuento: -${fmt(t.desc)}%0A`; if(envioSel) msg+=`Env√≠o: ${fmt(t.envio)}%0A`; if(t.tip) msg+=`Propina: ${fmt(t.tip)}%0A`;
      msg+=`Total: ${fmt(t.total)}%0A`; 
      if(envioSel) msg+=`Direcci√≥n: ${(document.getElementById('inDir').value||'').trim()}%0A`;
      if(nota) msg+=`Nota: ${encodeURIComponent(nota)}%0A`;
      const wsp = state.wsp || ''; if(!wsp){ alert('El local no tiene WhatsApp configurado'); return; }
      const url = `https://wa.me/${wsp}?text=${msg}`; window.open(url,'_blank');
    });

    (async()=>{
      const slug = qs('l'); if(!slug){ alert('Falta el par√°metro l'); return; }
      const cat = await loadJSON('data/'+slug+'.json');
      if(!cat){ document.getElementById('cats').innerHTML = '<p style="color:#7a4c00;background:#fff8e1;border:1px solid #ffe6a3;padding:10px;border-radius:10px">No encontramos el cat√°logo de este local. Verific√° que exista <code>data/'+slug+'.json</code>.</p>'; return; }
      document.getElementById('title').textContent = cat.nombre || 'Negocio';
      document.getElementById('sub').textContent = cat.subtitulo || '';
      document.getElementById('logo').src = (cat.logo||'assets/logo.svg');
      state.shipping = Number(cat.shipping||0); state.wsp = (cat.whatsapp||'').replace(/\D/g,'');
      state.categorias = cat.categorias||[];

      const wrap = document.getElementById('cats'); wrap.innerHTML='';
      state.categorias.forEach((c,ci)=>{
        const d = document.createElement('details'); d.className='cat'; // todos cerrados by default
        const s = document.createElement('summary'); s.innerHTML = '<span>'+c.categoria+'</span><span>‚ñæ</span>'; d.appendChild(s);
        const items = document.createElement('div'); items.className='items';
        (c.productos||[]).forEach((p,pi)=>{ const row=createRow(ci,pi,p); items.appendChild(row); });
        d.appendChild(items);
        d.addEventListener('toggle', e=>{ if(d.open){ document.querySelectorAll('details.cat').forEach(o=>{ if(o!==d) o.open=false; }); } });
        wrap.appendChild(d);
      });

      // eventos +/‚àí
      document.addEventListener('click',e=>{
        const btn=e.target.closest('button[data-id]'); if(!btn) return;
        const id=btn.dataset.id, d=Number(btn.dataset.d||0); const span=document.getElementById('q-'+id);
        const now=Math.max(0,(state.counts[id]||0)+d); state.counts[id]=now; if(span) span.textContent=now; updateFab();
      });
    })();
  </script>
</body>
</html>

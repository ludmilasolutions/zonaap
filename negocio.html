<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Negocio</title>
<link rel="icon" href="assets/logo.svg">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
:root{--azul:#0b376d;--azul-2:#062247;--amarillo:#ffcc00;--bg:#f4f7fb;--card:#fff;--b:#e5e7eb}
*{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:var(--bg);color:#0f172a}
a{color:inherit;text-decoration:none}
.header{background:linear-gradient(135deg,var(--azul) 0%,var(--azul-2) 100%);color:#fff;padding:16px 16px 26px}
.container{max-width:980px;margin:0 auto;padding:0 16px}
.back{display:inline-flex;align-items:center;gap:6px;color:#c7d2fe;font-weight:800;margin:8px 0 10px}
.brand{display:flex;align-items:center;gap:14px}
.logo{width:64px;height:64px;border-radius:14px;background:#0b1f3a;display:grid;place-items:center;border:1px solid rgba(255,255,255,.15)}
h1{margin:0;font-size:34px}
.sub{margin:4px 0 0;opacity:.9}
/* Categories as details */
.cat{margin:14px 0;background:var(--card);border:1px solid var(--b);border-radius:14px;overflow:hidden}
.cat>summary{list-style:none;background:#0b376d;color:#fff;padding:14px 16px;font-weight:900;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
.cat>summary::-webkit-details-marker{display:none}
.chev{transition:.2s}
.cat[open] .chev{transform:rotate(180deg)}
.count{background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.25);padding:2px 8px;border-radius:999px;font-size:13px;display:none}
.items{padding:8px 12px 12px;background:#f8fafc}
.item{display:grid;grid-template-columns:64px 1fr auto;gap:12px;align-items:center;background:#fff;border:1px solid var(--b);border-radius:12px;padding:10px;margin:10px 4px}
.thumb{width:64px;height:64px;border-radius:10px;overflow:hidden;background:#eef2ff;border:1px solid var(--b)}
.thumb img{width:100%;height:100%;object-fit:cover}
.item h3{margin:0 0 4px;font-size:16px;color:#0b376d}
.item p{margin:0 0 4px;color:#475569;font-size:14px}
.price{font-weight:900;color:#0b376d}
.qty{display:flex;align-items:center;gap:10px}
.qty button{width:36px;height:36px;border-radius:10px;border:1.5px solid #0b376d;background:#fff;font-weight:900;font-size:18px;cursor:pointer}
/* Cart FAB */
.fab{position:fixed;right:16px;bottom:18px;background:#062247;color:#fff;border:2px solid var(--amarillo);border-radius:9999px;display:flex;gap:10px;align-items:center;padding:12px 16px;font-weight:900;box-shadow:0 14px 30px rgba(0,0,0,.25);cursor:pointer}
/* Sheet */
.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.32);opacity:0;pointer-events:none;transition:.2s;z-index:99}
.backdrop.open{opacity:1;pointer-events:auto}
.sheet{position:fixed;left:0;right:0;bottom:0;transform:translateY(100%);background:#fff;border-top-left-radius:16px;border-top-right-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.18);max-height:90vh;display:grid;grid-template-rows:auto 1fr;z-index:100}
.sheet.open{transform:translateY(0)}
.sheet header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--b);padding:8px 10px 6px;border-top-left-radius:16px;border-top-right-radius:16px}
.steps{display:flex;gap:6px;align-items:center;font-weight:800;color:#64748b}
.step{display:flex;gap:6px;align-items:center}.dot{width:10px;height:10px;border-radius:999px;background:#cbd5e1}.step.active{color:#0b376d}.step.active .dot{background:var(--amarillo)}
.body{overflow:auto;padding:10px 12px 14px}
.segmented{display:flex;gap:8px;margin:.4rem 0 .8rem}
.segmented input{display:none}
.segmented label{flex:1;text-align:center;padding:10px 12px;border:1px solid #cfd3dc;border-radius:12px;cursor:pointer;font-weight:800;background:#fff}
.segmented input:checked+label{background:#0b376d;color:#ffcc00;border-color:#0b376d;box-shadow:0 6px 16px rgba(0,0,0,.12)}
label.block{display:block;margin:.6rem 0;font-weight:800}
.block input{width:100%;padding:12px;border:1px solid #cfd3dc;border-radius:12px}
.resume{background:#fff8e1;border:1px solid #ffe08a;border-radius:12px;padding:10px}
.resume h3{margin:0 0 8px}
.rlist{list-style:none;margin:8px 0;padding:0;display:grid;gap:6px}
.rline{display:grid;grid-template-columns:1fr auto auto;gap:6px;align-items:center;background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:6px 8px}
.total{display:grid;gap:6px;margin-top:6px}
.tline{display:flex;justify-content:space-between}
.btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
.primary{background:#0b376d;color:#ffcc00;border:none;border-radius:10px;padding:12px 14px;font-weight:900;cursor:pointer}
.secondary{background:#fff;border:1px solid #cfd3dc;border-radius:10px;padding:12px 14px;font-weight:800;cursor:pointer}
.toast{position:fixed;left:50%;bottom:88px;transform:translateX(-50%);background:#0b1f3a;color:#fff;border-left:4px solid #16a34a;padding:10px;border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,.25);z-index:200}
</style>
</head>
<body>
  <header class="header">
    <div class="container">
      <a class="back" href="index.html">‚Üê Volver</a>
      <div class="brand">
        <div class="logo"><img src="assets/logo.svg" alt="" style="width:38px;height:38px"></div>
        <div><h1 id="bizName">Negocio</h1><p id="bizSub" class="sub">Subt√≠tulo</p></div>
      </div>
    </div>
  </header>

  <div class="container" id="cats"></div>

  <button id="fab" class="fab" style="display:none">üõí <span id="fabTotal">$ 0</span> <span style="background:#ffcc00;color:#062247;border-radius:999px;padding:2px 8px" id="fabCount">0</span></button>

  <div id="backdrop" class="backdrop"></div>
  <div id="sheet" class="sheet" aria-modal="true" aria-labelledby="shTitle">
    <header>
      <div class="steps" id="steps"><span class="step" data-i="1"><span class="dot"></span>Datos</span> ‚Üí <span class="step" data-i="2"><span class="dot"></span>Resumen</span> ‚Üí <span class="step" data-i="3"><span class="dot"></span>WhatsApp</span></div>
    </header>
    <div class="body">
      <div class="segmented">
        <input id="opt-ret" type="radio" name="envio" value="retiro"><label for="opt-ret">Retiro</label>
        <input id="opt-env" type="radio" name="envio" value="envio"><label for="opt-env">Env√≠o</label>
      </div>
      <label class="block">Nombre<input id="nombre" placeholder="Tu nombre"></label>
      <label class="block" id="addrWrap" style="display:none">Direcci√≥n<input id="direccion" placeholder="Calle, n√∫mero, piso/depto"></label>

      <div class="resume">
        <h3>Resumen del pedido</h3>
        <ul id="rlist" class="rlist"></ul>
        <div class="total">
          <div class="tline"><span>Subtotal</span><span id="sub">$ 0</span></div>
          <div class="tline" id="shipLine" style="display:none"><span>Env√≠o</span><span id="ship">$ 0</span></div>
          <div class="tline"><span>Descuento</span><span id="disc">$ 0</span></div>
          <div class="tline"><span>Propina</span><span id="tip">$ 0</span></div>
          <div class="tline" style="font-weight:900"><span>Total</span><span id="tot">$ 0</span></div>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
          <input id="note" class="input" placeholder="üìù Nota (opcional)" style="flex:1;min-width:220px;border:1px solid #cfd3dc;border-radius:10px;padding:8px 10px">
          <input id="coupon" class="input" placeholder="üéÅ Cup√≥n (opcional)" style="width:180px;border:1px solid #cfd3dc;border-radius:10px;padding:8px 10px">
          <input id="tipPct" type="number" min="0" max="30" step="1" class="input" placeholder="% Propina" style="width:130px;border:1px solid #cfd3dc;border-radius:10px;padding:8px 10px">
        </div>
        <div class="btns">
          <button id="send" class="primary">Hacer pedido por WhatsApp</button>
          <button id="clear" class="secondary">Vaciar carrito</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" style="display:none"></div>

<script>
const fmt = n=> new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(n);
async function j(p){const r=await fetch(p); if(!r.ok) throw new Error(p+' '+r.status); return r.json();}

const slug = new URLSearchParams(location.search).get('l') || 'pizzeria-don-napo';
let AJ={}, BIZ={}, PROM={}, CART={}, SHIPPING=0, WSP='';

function toast(t){const el=document.getElementById('toast'); el.textContent=t; el.style.display='block'; setTimeout(()=>el.style.display='none',2200);}
function setSteps(i){document.querySelectorAll('#steps .step').forEach(s=>s.classList.toggle('active',Number(s.dataset.i)===i));}

function renderCats(){
  const root=document.getElementById('cats'); root.innerHTML='';
  const cats=(BIZ.categorias||[]);
  cats.forEach((c,idx)=>{
    const det=document.createElement('details'); det.className='cat'; // closed by default
    det.innerHTML = `<summary>${c.categoria}<span class="chev">‚ñæ</span></summary><div class="items"></div>`;
    det.addEventListener('toggle',()=>{
      if(det.open){ document.querySelectorAll('.cat').forEach(d=>{ if(d!==det) d.open=false; }); }
    });
    const items = det.querySelector('.items');
    (c.productos||[]).forEach((p,i)=>{
      const id = `${idx}-${i}`;
      const q = CART[id]||0;
      const div = document.createElement('div'); div.className='item';
      const img = p.img || 'assets/placeholder.svg';
      div.innerHTML = `<div class="thumb"><img src="${img}" alt=""></div>
        <div><h3>${p.nombre}</h3><p>${p.desc||''}</p><div class="price">${fmt(p.precio)}</div></div>
        <div class="qty"><button data-id="${id}" data-d="-1">‚àí</button><span id="q-${id}">${q}</span><button data-id="${id}" data-d="1">+</button></div>`;
      div.dataset.name = p.nombre; div.dataset.price = p.precio;
      items.appendChild(div);
    });
    root.appendChild(det);
  });
  root.addEventListener('click',e=>{
    const b=e.target.closest('button[data-id]'); if(!b) return;
    const id=b.dataset.id, d=Number(b.dataset.d);
    const newQ=Math.max(0,(CART[id]||0)+d); CART[id]=newQ;
    const span=document.getElementById('q-'+id); if(span) span.textContent=newQ;
    saveCart(); renderFab(); renderResume();
  },{passive:true});
}

function mergePromos(){
  const promos = PROM.promos||[];
  const today = new Date().toISOString().slice(0,10);
  const vig = promos.filter(p=>!p.vigencia_hasta || p.vigencia_hasta>=today);
  if(!vig.length) return;
  const prods = vig.map(p=>({nombre:p.nombre, desc:p.desc||'', precio:p.precio, img:'assets/placeholder.svg', _promo:{precio_original:p.precio_original||null, tag:p.tag||null}}));
  BIZ.categorias = [{ categoria:'‚≠ê Promos', productos: prods }, ...(BIZ.categorias||[])];
}

function renderFab(){
  const cnt=Object.values(CART).reduce((a,b)=>a+(b||0),0);
  const tot = Object.entries(CART).reduce((s,[id,q])=>{ if(q<=0) return s; const [ci,pi]=id.split('-').map(n=>Number(n)); const prod=BIZ.categorias?.[ci]?.productos?.[pi]; return s+(prod?prod.precio*q:0); },0);
  document.getElementById('fabCount').textContent = cnt;
  document.getElementById('fabTotal').textContent = fmt(tot);
  document.getElementById('fab').style.display = cnt>0 ? 'inline-flex' : 'none';
}

function renderResume(){
  const ul=document.getElementById('rlist'); ul.innerHTML='';
  let subtotal=0;
  Object.entries(CART).forEach(([id,q])=>{
    if(q<=0) return;
    const [ci,pi]=id.split('-').map(n=>Number(n));
    const prod=BIZ.categorias?.[ci]?.productos?.[pi]; if(!prod) return;
    const line=prod.precio*q; subtotal+=line;
    const li=document.createElement('li'); li.className='rline';
    li.innerHTML=`<span>${prod.nombre}</span><span>x${q}</span><span>${fmt(line)}</span>`;
    ul.appendChild(li);
  });
  const envioSel=document.querySelector('input[name=envio]:checked')?.value||'';
  const shippingCost= envioSel==='envio' ? (BIZ.shipping ?? AJ.checkout?.default_shipping ?? 0) : 0;
  const cup = (document.getElementById('coupon').value||'').trim();
  const demo = (AJ.checkout?.coupon_code||'OFF10');
  const demoPct = Number(AJ.checkout?.coupon_percent||10);
  const desc = cup && cup.toUpperCase()===String(demo).toUpperCase() ? Math.round(subtotal*demoPct/100) : 0;
  const tipPct = Math.max(0, Math.min(30, Number(document.getElementById('tipPct').value||0)));
  const tip = Math.round(subtotal*tipPct/100);

  document.getElementById('sub').textContent=fmt(subtotal);
  document.getElementById('shipLine').style.display = shippingCost>0 ? 'flex' : 'none';
  document.getElementById('ship').textContent=fmt(shippingCost);
  document.getElementById('disc').textContent=fmt(desc);
  document.getElementById('tip').textContent=fmt(tip);
  document.getElementById('tot').textContent=fmt(subtotal+shippingCost-desc+tip);
}

function saveCart(){ localStorage.setItem('za_cart_'+slug, JSON.stringify(CART)); }
function loadCart(){ try{ CART = JSON.parse(localStorage.getItem('za_cart_'+slug)||'{}') }catch{ CART={} } }

(async function init(){
  try{
    AJ = await j('data/ajustes.json').catch(()=>({}));
    if(AJ.brand){ document.documentElement.style.setProperty('--azul', AJ.brand.primary||'#0b376d'); document.documentElement.style.setProperty('--amarillo', AJ.brand.secondary||'#ffcc00'); }
    BIZ = await j('data/'+slug+'.json');
    PROM = await j('data/promos/'+slug+'.json').catch(()=>({promos:[]}));
    mergePromos();
    document.getElementById('bizName').textContent=BIZ.nombre||'Negocio';
    document.getElementById('bizSub').textContent=BIZ.subtitulo||'';
    SHIPPING = BIZ.shipping ?? AJ.checkout?.default_shipping ?? 0;
    WSP = (BIZ.whatsapp||'').replace(/\D/g,'');
    loadCart();
    renderCats(); renderFab(); renderResume();
  }catch(e){
    document.querySelector('#cats').innerHTML = '<p style="padding:16px;background:#fff;border:1px solid #e5e7eb;border-radius:12px">No se pudo cargar el cat√°logo. Verific√° el JSON del local.</p>';
    console.error(e);
  }
})();

// Category close/open one-at-a-time handled in renderCats toggle

// FAB + sheet logic
const fab=document.getElementById('fab'); const sheet=document.getElementById('sheet'); const back=document.getElementById('backdrop');
function openSheet(){ sheet.classList.add('open'); back.classList.add('open'); setSteps(1); }
function closeSheet(){ sheet.classList.remove('open'); back.classList.remove('open'); }
fab.addEventListener('click', openSheet); back.addEventListener('click', closeSheet);
document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeSheet(); });

// Env√≠o / retiro + inputs
document.querySelectorAll('input[name=envio]').forEach(r=> r.addEventListener('change',()=>{
  const v=document.querySelector('input[name=envio]:checked')?.value||'';
  document.getElementById('addrWrap').style.display = v==='envio' ? 'block':'none';
  renderResume(); setSteps( v ? 2 : 1 );
}));
['nombre','direccion','coupon','tipPct','note'].forEach(id=>{
  const el=document.getElementById(id); if(el) el.addEventListener('input',()=>{ renderResume(); setSteps(2); });
});

document.getElementById('clear').addEventListener('click',()=>{
  CART={}; saveCart(); renderCats(); renderFab(); renderResume(); toast('Carrito vaciado');
});

document.getElementById('send').addEventListener('click', ()=>{
  const envioSel=document.querySelector('input[name=envio]:checked')?.value||'';
  const nombre=(document.getElementById('nombre').value||'').trim();
  const addr=(document.getElementById('direccion').value||'').trim();
  if(!envioSel){ toast('Eleg√≠ Retiro o Env√≠o'); return; }
  if(!nombre){ toast('Ingres√° tu nombre'); return; }
  const cnt=Object.values(CART).reduce((a,b)=>a+(b||0),0);
  if(!cnt){ toast('El carrito est√° vac√≠o'); return; }
  if(envioSel==='envio'&&!addr){ toast('Ingres√° tu direcci√≥n'); return; }

  let msg = `Hola, soy ${nombre}. Quiero hacer un pedido en ${BIZ.nombre}:\n`;
  Object.entries(CART).forEach(([id,q])=>{
    if(q<=0) return;
    const [ci,pi]=id.split('-').map(n=>Number(n));
    const p=BIZ.categorias?.[ci]?.productos?.[pi]; if(!p) return;
    msg += `- ${p.nombre} x${q} - ${fmt(p.precio*q)}\n`;
  });
  const totalTxt = document.getElementById('tot').textContent;
  msg += envioSel==='envio' ? `Env√≠o a: ${addr}\n` : 'Retiro en el local\n';
  const note=(document.getElementById('note').value||'').trim(); if(note) msg+=`Nota: ${note}\n`;
  const cup=(document.getElementById('coupon').value||'').trim(); if(cup) msg+=`Cup√≥n: ${cup}\n`;
  const tipPct=document.getElementById('tipPct').value||''; if(tipPct) msg+=`Propina: ${tipPct}%\n`;
  msg += `Total: ${totalTxt}`;

  if(!WSP){ toast('El local no configur√≥ WhatsApp'); return; }
  window.open(`https://wa.me/${WSP}?text=${encodeURIComponent(msg)}`,'_blank');
  closeSheet(); toast('Abriendo WhatsApp‚Ä¶');
});
</script>
</body>
</html>

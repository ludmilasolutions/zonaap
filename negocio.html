<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Negocio | zonaap</title>
  <link rel="icon" href="assets/logo.svg">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --azul:#0b2c4d; --azul-2:#09243e; --amarillo:#ffcc00;
      --bg:#f5f7fb; --text:#1f2a37; --card:#fff; --borde:#e5e7eb; --shadow:0 10px 24px rgba(0,0,0,.08);
      --ok:#16a34a; --error:#dc2626;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .hero{background:linear-gradient(90deg,var(--azul),var(--azul-2));color:#fff;padding:24px 16px}
    .hero .wrap{max-width:980px;margin:0 auto;display:flex;gap:14px;align-items:center}
    .hero img{width:64px;height:64px;border-radius:14px;background:#123}
    .hero h1{font-size:2rem}
    .hero p{opacity:.9;margin-top:2px}
    main{max-width:980px;margin:12px auto;padding:0 16px}
    .back{display:inline-flex;gap:6px;align-items:center;color:#fff;text-decoration:none;margin-bottom:10px}
    .accord{display:grid;gap:12px;margin:14px 0 80px}
    .acc{border:1px solid var(--borde);border-radius:16px;overflow:hidden;background:var(--card)}
    .acc > summary{list-style:none;cursor:pointer;padding:14px 16px;background:#0f2f52;color:#fff;font-weight:800;display:flex;justify-content:space-between;align-items:center}
    .acc[open] > summary{background:#14365d}
    .items{padding:8px 8px 14px;display:grid;gap:10px}
    .item{display:grid;grid-template-columns:64px 1fr auto;gap:12px;align-items:center;background:#fff;border:1px solid var(--borde);border-radius:14px;padding:8px 10px}
    .item img{width:64px;height:64px;border-radius:10px;border:1px solid var(--borde)}
    .item h4{margin:0 0 4px}
    .price{font-weight:800;margin-top:4px}
    .qty{display:flex;gap:8px;align-items:center}
    .qty button{width:36px;height:36px;border-radius:12px;border:2px solid #14365d;background:#fff;font-weight:900;cursor:pointer}
    .qty span{min-width:18px;text-align:center}
    /* FAB */
    .fab{position:fixed;right:16px;bottom:24px;background:#0b2c4d;color:#fff;border:2px solid var(--amarillo);border-radius:999px;display:flex;gap:8px;align-items:center;padding:12px 16px;font-weight:800;box-shadow:var(--shadow);cursor:pointer}
    .fab .dot{background:var(--amarillo);color:#09243e;border-radius:99px;min-width:26px;height:26px;display:grid;place-items:center;font-weight:900}
    .fab.hide{opacity:.0;transform:translateY(10px);pointer-events:none;transition:.2s}
    /* Sheet */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);opacity:0;pointer-events:none;transition:.2s;z-index:98}
    .backdrop.open{opacity:1;pointer-events:auto}
    .sheet{position:fixed;left:50%;transform:translate(-50%,110%);bottom:0;background:#fff;border-top-left-radius:18px;border-top-right-radius:18px;box-shadow:var(--shadow);width:min(720px,96vw);max-height:88vh;display:grid;grid-template-rows:auto 1fr;z-index:99;transition:.25s}
    .sheet.open{transform:translate(-50%,0)}
    .sheet header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--borde);padding:10px 14px;font-weight:900;display:flex;align-items:center;gap:10px}
    .sheet header .x{margin-left:auto;border:1px solid var(--borde);width:38px;height:38px;border-radius:10px;background:#fff;font-size:18px}
    .sheet .body{overflow:auto;padding:12px 14px 18px}
    .seg{display:flex;gap:8px;margin:.4rem 0 .6rem}
    .seg input{display:none}
    .seg label{flex:1;text-align:center;border:1px solid var(--borde);border-radius:12px;padding:10px 12px;font-weight:800;background:#fff;cursor:pointer}
    .seg input:checked + label{background:#0b2c4d;color:#ffcc00;border-color:#0b2c4d}
    .sum{background:#fff7cf;border:1px solid #ffe08a;border-radius:14px;padding:10px;margin-top:8px}
    .sum h3{margin:0 0 8px}
    .sum .row{display:flex;justify-content:space-between;padding:4px 0}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{background:#0b2c4d;color:#ffcc00;border:2px solid #ffcc00;border-radius:12px;padding:12px 14px;font-weight:900;cursor:pointer}
    .btn.secondary{background:#fff;color:#123;border-color:#cbd5e1}
    .muted{opacity:.7}
  </style>
</head>
<body>
  <div class="hero">
    <a class="back" href="index.html">‚Üê Volver</a>
    <div class="wrap">
      <img id="bLogo" src="assets/logo.svg" alt="Logo">
      <div>
        <h1 id="bName">Negocio</h1>
        <p id="bSub" class="muted">Subt√≠tulo</p>
      </div>
    </div>
  </div>

  <main>
    <section id="cats" class="accord"></section>
  </main>

  <button id="fab" class="fab hide"><span>üõí</span><span id="fabTotal">$ 0</span><span class="dot" id="fabCount">0</span></button>

  <div id="bd" class="backdrop"></div>
  <div id="sheet" class="sheet" aria-modal="true">
    <header>Tu pedido <button id="x" class="x">‚úï</button></header>
    <div class="body">
      <div class="seg" role="tablist" aria-label="Entrega">
        <input id="sRet" type="radio" name="envio" value="retiro" checked><label for="sRet">Retiro</label>
        <input id="sEnv" type="radio" name="envio" value="envio"><label for="sEnv">Env√≠o</label>
      </div>
      <div style="display:grid;gap:8px;grid-template-columns:1fr 1fr">
        <label>Nombre <input id="cName" type="text" placeholder="Tu nombre" style="width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:10px"></label>
        <label id="addrWrap" style="display:none">Direcci√≥n <input id="cAddr" type="text" placeholder="Calle, n√∫mero, piso/depto" style="width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:10px"></label>
      </div>

      <div class="sum">
        <h3>Resumen del pedido</h3>
        <div id="sumItems" class="muted">A√∫n no agregaste productos.</div>
        <div class="row"><span>Subtotal</span><strong id="sub">$ 0</strong></div>
        <div class="row" id="shipRow" style="display:none"><span>Env√≠o</span><strong id="ship">$ 0</strong></div>
        <div class="row"><span>Descuento</span><strong id="disc">$ 0</strong></div>
        <div class="row"><span>Propina</span><strong id="tip">$ 0</strong></div>
        <div class="row" style="border-top:1px dashed #e5e7eb;margin-top:6px;padding-top:8px"><span>Total</span><strong id="tot">$ 0</strong></div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
        <label>Nota (opcional) <input id="note" type="text" placeholder="Ej: sin sal‚Ä¶" style="width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:10px"></label>
        <label>Cup√≥n (opcional) <input id="coupon" type="text" placeholder="Ej: PIZZA10" style="width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:10px"></label>
        <label>Propina % <input id="tipPct" type="number" min="0" value="0" style="width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:10px"></label>
        <label>Propina $ <input id="tipAmt" type="number" min="0" value="0" style="width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:10px"></label>
      </div>

      <div class="btns">
        <button id="go" class="btn">Hacer pedido por WhatsApp</button>
        <button id="clear" class="btn secondary">Vaciar carrito</button>
      </div>
    </div>
  </div>

<script>
const $ = (s,ctx=document)=>ctx.querySelector(s);
const qs = new URLSearchParams(location.search);
const slug = qs.get('l')||'';

const fmt = n => new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(n);

let SHIPPING = 0, WSP = '', CATS = [], CART = {};

async function load(){
  try{
    const url = 'data/'+encodeURIComponent(slug)+'.json';
    const res = await fetch(url);
    if(!res.ok) throw new Error('No se encontr√≥ el cat√°logo para '+slug);
    const data = await res.json(); // si viene HTML 404, lanzar√° SyntaxError; lo capturamos abajo
    $('#bName').textContent = data.nombre || 'Negocio';
    $('#bSub').textContent = data.subtitulo || '';
    $('#bLogo').src = (data.logo || 'assets/logo.svg');
    WSP = String(data.whatsapp||'').replace(/\D/g,'');
    SHIPPING = Number(data.shipping||0);
    CATS = data.categorias || [];
    renderCats();
  }catch(err){
    console.error(err);
    $('.accord').innerHTML = '<p style="padding:14px;background:#fff;border:1px solid #e5e7eb;border-radius:12px">No se pudo cargar este negocio. Verific√° el <code>slug</code> o el archivo JSON correspondiente en <code>/data</code>.</p>';
  }
}

function renderCats(){
  const cont = $('#cats');
  cont.innerHTML = '';
  CATS.forEach((c,idx)=>{
    const det = document.createElement('details');
    det.className='acc';
    // cerradas por defecto
    const sum = document.createElement('summary');
    sum.innerHTML = `<span>${c.categoria||'Categor√≠a'}</span><span>‚ñæ</span>`;
    const wrap = document.createElement('div'); wrap.className='items';
    (c.productos||[]).forEach((p,i)=>{
      const id = `${idx}-${i}`;
      const row = document.createElement('div'); row.className='item';
      row.innerHTML = \`
        <img src="\${p.img||'assets/placeholder.svg'}" alt="\${p.nombre}">
        <div><h4>\${p.nombre}</h4><div class="muted">\${p.desc||''}</div><div class="price">\${fmt(p.precio||0)}</div></div>
        <div class="qty">
          <button aria-label="Quitar" data-id="\${id}" data-d="-1">‚àí</button>
          <span id="q-\${id}">0</span>
          <button aria-label="Agregar" data-id="\${id}" data-d="1">+</button>
        </div>\`;
      row.dataset.name = p.nombre; row.dataset.price = p.precio||0;
      wrap.appendChild(row);
    });
    det.appendChild(sum); det.appendChild(wrap); cont.appendChild(det);
  });

  // Exclusi√≥n: abre una y cierra el resto
  cont.querySelectorAll('details').forEach((d)=>{
    d.addEventListener('toggle',()=>{
      if(d.open){
        cont.querySelectorAll('details').forEach(o=>{ if(o!==d) o.removeAttribute('open'); });
      }
    });
  });

  // Eventos qty
  cont.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-id]');
    if(!btn) return;
    const id = btn.dataset.id;
    const d = Number(btn.dataset.d);
    const span = $('#q-'+id);
    const row = span.closest('.item');
    const name = row.dataset.name, price = Number(row.dataset.price||0);
    CART[id] = Math.max(0, (CART[id]||0)+d);
    span.textContent = CART[id];
    updateFab();
    saveCartMeta(name, price, CART[id]);
  }, {capture:true});
}

function saveCartMeta(name, price, qty){
  // optional: could track analytics; left simple here
}

function count(){ return Object.values(CART).reduce((a,b)=>a+(b||0),0); }
function subtotal(){
  let s=0;
  $('#cats').querySelectorAll('.item').forEach((row,idx)=>{
    const qty = Number($('#q-'+idx)?.textContent||0);
  });
  // safer: loop CART
  for(const id in CART){
    if(CART[id]>0){
      const span = $('#q-'+id); if(!span) continue;
      const row = span.closest('.item'); const price = Number(row?.dataset?.price||0);
      s += price * CART[id];
    }
  }
  return s;
}

function updateFab(){
  const n = count(); const fab = $('#fab');
  if(n>0){ fab.classList.remove('hide'); }
  else { fab.classList.add('hide'); }
  $('#fabCount').textContent = n;
  $('#fabTotal').textContent = fmt(subtotal());
}

function openSheet(){ $('#bd').classList.add('open'); $('#sheet').classList.add('open'); updateSummary(); }
function closeSheet(){ $('#bd').classList.remove('open'); $('#sheet').classList.remove('open'); }

$('#fab').addEventListener('click', openSheet);
$('#x').addEventListener('click', closeSheet);
$('#bd').addEventListener('click', closeSheet);

function updateSummary(){
  const wrap = $('#sumItems');
  let html = '';
  for(const id in CART){
    const qty = CART[id]; if(qty<=0) continue;
    const span = $('#q-'+id); if(!span) continue;
    const row = span.closest('.item'); const name = row.dataset.name; const price = Number(row.dataset.price||0);
    html += \`<div style="display:flex;justify-content:space-between;gap:10px"><span>\${name} √ó\${qty}</span><strong>\${fmt(price*qty)}</strong></div>\`;
  }
  wrap.innerHTML = html || '<span class="muted">A√∫n no agregaste productos.</span>';

  const envioSel = document.querySelector('input[name=envio]:checked')?.value || 'retiro';
  const sub = subtotal();
  let envio = (envioSel==='envio' && count()>0) ? SHIPPING : 0;

  // Cup√≥n
  const code = ($('#coupon').value||'').trim().toUpperCase();
  let desc = 0;
  if(code==='PIZZA10') desc = Math.round(sub*0.10);
  if(code==='NAPO200') desc = 200;
  if(code==='ENVIOFREE') envio = 0;

  // Propina
  const pct = Number($('#tipPct').value||0);
  const amt = Number($('#tipAmt').value||0);
  const tip = Math.max(amt, Math.round(sub*pct/100));

  const tot = Math.max(0, sub - desc + envio + tip);

  $('#sub').textContent = fmt(sub);
  $('#shipRow').style.display = envio>0 ? '' : 'none';
  $('#ship').textContent = fmt(envio);
  $('#disc').textContent = fmt(desc);
  $('#tip').textContent = fmt(tip);
  $('#tot').textContent = fmt(tot);
}

document.querySelectorAll('input[name=envio]').forEach(r=>r.addEventListener('change',()=>{
  const envio = r.value==='envio';
  $('#addrWrap').style.display = envio ? '' : 'none';
  updateSummary();
}));
['coupon','tipPct','tipAmt','note','cName','cAddr'].forEach(id=>$('#'+id).addEventListener('input',updateSummary));

$('#clear').addEventListener('click',()=>{ CART={}; document.querySelectorAll('[id^="q-"]').forEach(s=>s.textContent='0'); updateFab(); updateSummary(); });

$('#go').addEventListener('click', ()=>{
  const envioSel = document.querySelector('input[name=envio]:checked')?.value || 'retiro';
  const name = ($('#cName').value||'').trim();
  const addr = ($('#cAddr').value||'').trim();
  if(!name){ alert('Ingres√° tu nombre'); return; }
  if(envioSel==='envio' && !addr){ alert('Ingres√° tu direcci√≥n'); return; }
  if(count()===0){ alert('Agreg√° productos'); return; }

  // Armar WSP
  let msg = \`Hola, soy \${name}. Quiero hacer un pedido:\n\`;
  for(const id in CART){
    const qty = CART[id]; if(qty<=0) continue;
    const span = $('#q-'+id); if(!span) continue;
    const row = span.closest('.item'); const nom = row.dataset.name; const pr = Number(row.dataset.price||0);
    msg += \`- \${nom} x\${qty} - \${fmt(pr*qty)}\n\`;
  }
  const sub = subtotal();
  const envio = (envioSel==='envio' && count()>0) ? SHIPPING : 0;
  const code = ($('#coupon').value||'').trim().toUpperCase();
  let desc = 0; if(code==='PIZZA10') desc=Math.round(sub*0.10); if(code==='NAPO200') desc=200; if(code==='ENVIOFREE') {}
  const pct = Number($('#tipPct').value||0), amt = Number($('#tipAmt').value||0);
  const tip = Math.max(amt, Math.round(sub*pct/100));
  const tot = Math.max(0, sub - desc + envio + tip);
  if(envioSel==='envio') msg += \`Env√≠o a: \${addr} (\${fmt(envio)})\n\`; else msg += 'Retiro en el local\n';
  if(code) msg += \`Cup√≥n: \${code}\n\`;
  const note = ($('#note').value||'').trim(); if(note) msg += \`Nota: \${note}\n\`;
  if(tip>0) msg += \`Propina: \${fmt(tip)}\n\`;
  msg += \`Total: \${fmt(tot)}\`;

  const wsp = WSP || '';
  const url = 'https://wa.me/'+wsp+'?text='+encodeURIComponent(msg);
  window.open(url, '_blank');
});

load();
</script>
</body>
</html>

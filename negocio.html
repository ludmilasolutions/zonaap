<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zonaap | Negocio</title>
<link rel="icon" href="assets/logo.svg">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --az:#0b2a4a; --az2:#081a2f; --am:#ffcc00; --bg:#f5f7fb; --card:#fff; --text:#0f172a;
  --muted:#6b7280; --bord:#e5e7eb; --ring:rgba(255,204,0,.35);
  --ok:#16a34a; --err:#ef4444;
}
*{box-sizing:border-box} body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:var(--text);background:var(--bg);margin:0}
.wrap{max-width:1040px;margin:0 auto;padding:0 16px}
.hero{background:linear-gradient(120deg,var(--az) 0%,var(--az2) 100%);color:#fff;padding:18px 0 28px;margin-bottom:18px}
.back{color:#c7d2fe;text-decoration:none;display:inline-flex;gap:8px;align-items:center;margin:0 0 12px 0}
.hbox{display:flex;gap:14px;align-items:center}
.logo{width:64px;height:64px;border-radius:14px;background:#0b2a4a22;display:grid;place-items:center}
.logo img{width:64px;height:64px;border-radius:14px}
h1{margin:0;font-size:36px;letter-spacing:.2px}
.sub{opacity:.9;margin:4px 0 0}
/* categories as accordion */
.accordion{display:grid;gap:12px;margin:10px 0 80px}
details{background:var(--card);border:1px solid var(--bord);border-radius:16px;overflow:hidden}
summary{list-style:none;cursor:pointer;display:flex;justify-content:space-between;align-items:center;padding:16px 16px;background:#0b2a4a;color:#e2e8f0;font-weight:900}
summary::-webkit-details-marker{display:none}
.chev{width:26px;height:26px;border-radius:9px;background:#0b2a4a33;display:grid;place-items:center}
.prod{display:grid;grid-template-columns:72px 1fr auto;align-items:center;gap:12px;padding:12px 16px;border-top:1px solid var(--bord);background:#fff}
.prod:hover{background:#fafafa}
.prod img{width:64px;height:64px;border-radius:12px;border:1px solid var(--bord);background:#eef2f7}
.prod h3{margin:0 0 2px 0;font-size:18px}
.pdesc{margin:0;color:var(--muted);font-size:14px}
.price{font-weight:900;margin-top:6px}
.qty{display:flex;align-items:center;gap:8px}
.btnc{width:38px;height:38px;border-radius:10px;border:2px solid #0b2a4a33;background:#fff;cursor:pointer;font-size:18px}
/* FAB Cart */
.fab{position:fixed;right:16px;bottom:18px;z-index:40;background:#0b2a4a;color:#e0f2fe;border:2px solid var(--am);
  display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:9999px;font-weight:900;box-shadow:0 12px 28px rgba(0,0,0,.22);cursor:pointer}
.fab .pill{background:var(--am);color:#0b1325;border-radius:999px;padding:6px 10px}
/* Sheet */
.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.3);opacity:0;pointer-events:none;transition:.2s;z-index:49}
.backdrop.open{opacity:1;pointer-events:auto}
.sheet{position:fixed;left:0;right:0;bottom:0;transform:translateY(100%);background:#fff;border-top-left-radius:18px;border-top-right-radius:18px;
  box-shadow:0 -12px 40px rgba(0,0,0,.22);transition:.28s;max-height:92vh;display:grid;grid-template-rows:auto 1fr;z-index:50}
.sheet.open{transform:translateY(0)}
.shead{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--bord);padding:10px 16px 6px}
.sgrid{padding:12px 16px;overflow:auto}
.steps{display:flex;gap:8px;color:#64748b;font-weight:900;font-size:13px}
.step.active{color:#0b2a4a}
.segmented{display:flex;gap:8px;margin:10px 0}
.segmented input{display:none}
.segmented label{flex:1;text-align:center;padding:10px;border:1px solid var(--bord);border-radius:12px;cursor:pointer;font-weight:900;background:#fff}
.segmented input:checked + label{background:#0b2a4a;color:#ffcc00;border-color:#0b2a4a}
label.txt{display:block;margin:10px 0 0;font-weight:900}
input[type="text"]{width:100%;padding:12px 14px;border:1px solid var(--bord);border-radius:12px;outline:none}
input[type="text"]:focus{box-shadow:0 0 0 4px var(--ring)}
.summary{background:#fff8db;border:1px solid #ffe69c;border-radius:14px;padding:12px;margin-top:8px}
.row{display:flex;justify-content:space-between;gap:12px;padding:6px 0}
.total{border-top:1px dashed #d7d7d7;margin-top:6px;padding-top:8px;font-weight:900}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.btn{background:#0b2a4a;color:#ffcc00;border:2px solid #0b2a4a;border-radius:12px;padding:12px 16px;font-weight:900;cursor:pointer}
.btn.ghost{background:#fff;color:#0b2a4a}
.small{font-size:13px;color:#64748b}
.badge{background:#0b2a4a1a;color:#0b2a4a;border:1px solid #0b2a4a33;border-radius:999px;font-size:12px;padding:4px 8px}
.note{width:100%;padding:10px;border:1px solid var(--bord);border-radius:12px}
</style>
</head>
<body>
  <section class="hero">
    <div class="wrap">
      <a class="back" href="index.html">‚Üê Volver</a>
      <div class="hbox">
        <div class="logo"><img id="bizLogo" src="assets/logo.svg" alt=""></div>
        <div>
          <h1 id="bizName">Negocio</h1>
          <p class="sub" id="bizSub">Subt√≠tulo</p>
        </div>
      </div>
    </div>
  </section>

  <main class="wrap">
    <div id="accordion" class="accordion"></div>
  </main>

  <button id="fab" class="fab" style="display:none">
    <span>üõí</span>
    <span id="fabTotal">$ 0</span>
    <span class="pill" id="fabCount">0</span>
  </button>

  <div id="bd" class="backdrop"></div>
  <section id="sheet" class="sheet" aria-hidden="true">
    <header class="shead">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Tu pedido</strong>
        <button id="closeSheet" class="btn ghost">‚úï</button>
      </div>
      <div class="steps small"><span class="step" data-step="1">Datos</span> ‚Üí <span class="step" data-step="2">Resumen</span> ‚Üí <span class="step" data-step="3">WhatsApp</span></div>
    </header>
    <div class="sgrid">
      <div class="segmented" role="tablist" aria-label="Entrega">
        <input id="opt-ret" type="radio" name="envio" value="retiro"><label for="opt-ret">Retiro</label>
        <input id="opt-env" type="radio" name="envio" value="envio"><label for="opt-env">Env√≠o</label>
      </div>
      <label class="txt">Nombre
        <input type="text" id="nombre" placeholder="Tu nombre">
      </label>
      <label class="txt" id="addrWrap" style="display:none">Direcci√≥n
        <input type="text" id="direccion" placeholder="Calle, n√∫mero, piso/depto">
      </label>

      <div class="summary">
        <div class="row"><strong>Resumen del pedido</strong><span id="sumSub"></span></div>
        <div id="sumLines" class="small"></div>

        <div class="row small"><span>üìù Nota (opcional)</span></div>
        <textarea id="nota" class="note" rows="2" placeholder="Ej: sin sal, dejar en porter√≠a"></textarea>

        <div class="row"><span class="small">üéüÔ∏è Cup√≥n (opcional)</span><input id="cupon" type="text" placeholder="C√≥digo de descuento" style="max-width:220px;padding:10px;border:1px solid #e5e7eb;border-radius:10px"></div>

        <div class="row small"><span>Propina (opcional)</span>
          <input id="propina" type="text" placeholder="% o $ (ej: 10% / 300)" style="max-width:160px;padding:10px;border:1px solid #e5e7eb;border-radius:10px">
        </div>

        <div class="row"><span>Subtotal</span><strong id="subt">$ 0</strong></div>
        <div class="row" id="envRow" style="display:none"><span>Env√≠o</span><strong id="env">$ 0</strong></div>
        <div class="row" id="descRow" style="display:none"><span>Descuento</span><strong id="desc">‚àí $ 0</strong></div>
        <div class="row" id="tipRow" style="display:none"><span>Propina</span><strong id="tip">$ 0</strong></div>
        <div class="row total"><span>Total</span><strong id="tot">$ 0</strong></div>

        <div class="actions">
          <button class="btn" id="btnWsp">Hacer pedido por WhatsApp</button>
          <button class="btn ghost" id="btnVaciar">Vaciar carrito</button>
        </div>
      </div>
    </div>
  </section>

<script>
const $ = s=>document.querySelector(s);
const params = new URLSearchParams(location.search);
const slug = params.get('l') || '';
const accord = $("#accordion");
const fab = $("#fab");
const bd = $("#bd");
const sheet = $("#sheet");
const steps = document.querySelectorAll('.step');
let WSP='';
let SHIPPING=0;
let catalog = null;

// Estado del carrito
const cantidades = new Map(); // key -> qty
function keyFor(catIdx, pIdx){ return catIdx+':'+pIdx; }

// Cargar JSON del negocio
async function load(){
  try{
    const r = await fetch(`data/${slug}.json`);
    if(!r.ok) throw new Error('No encontrado');
    catalog = await r.json();
    $("#bizName").textContent = catalog.nombre || 'Negocio';
    $("#bizSub").textContent = catalog.subtitulo || '';
    $("#bizLogo").src = (catalog.logo || 'assets/logo.svg');
    WSP = (catalog.whatsapp||'').replace(/\D/g,'');
    SHIPPING = Number(catalog.shipping||0);
    renderCats(catalog.categorias||[]);
  }catch(e){
    accord.innerHTML = '<p>No encontramos este negocio.</p>';
  }
}
load();

function renderCats(cats){
  accord.innerHTML = '';
  cats.forEach((c,ci)=>{
    const det = document.createElement('details'); // cerradas por defecto
    const sum = document.createElement('summary');
    sum.innerHTML = `<span>${c.categoria}</span><span class="chev">‚ñæ</span>`;
    det.appendChild(sum);

    (c.productos||[]).forEach((p,pi)=>{
      const id = keyFor(ci,pi);
      const row = document.createElement('div');
      row.className='prod';
      row.innerHTML = \`
        <img src="\${p.img||'assets/placeholder.svg'}" alt="\${p.nombre}">
        <div>
          <h3>\${p.nombre}</h3>
          <p class="pdesc">\${p.desc||''}</p>
          <div class="price">\${format(p.precio||0)}</div>
        </div>
        <div class="qty">
          <button class="btnc" aria-label="Quitar">‚àí</button>
          <span id="q-\${id}">0</span>
          <button class="btnc" aria-label="Agregar">Ôºã</button>
        </div>\`;
      const btns = row.querySelectorAll('.btnc');
      btns[0].addEventListener('click',()=>chg(id,p,-1));
      btns[1].addEventListener('click',()=>chg(id,p, 1));
      det.appendChild(row);
    });
    // Acorde√≥n: solo uno abierto
    det.addEventListener('toggle', e=>{
      if(det.open){
        document.querySelectorAll('details').forEach(d=>{ if(d!==det) d.removeAttribute('open'); });
      }
    });
    accord.appendChild(det);
  });
}

function chg(id, p, delta){
  const q = (cantidades.get(id)||0) + delta;
  cantidades.set(id, Math.max(0,q));
  const span = document.getElementById('q-'+id); if(span) span.textContent = Math.max(0,q);
  saveCart(); updateFab(); updateSummary();
}
function countItems(){ let n=0; cantidades.forEach(v=>n+=v); return n; }
function updateFab(){
  const n = countItems();
  const t = calcTotals().total;
  if(n>0){ fab.style.display='flex'; $("#fabCount").textContent=n; $("#fabTotal").textContent=format(t); }
  else{ fab.style.display='none'; }
}
fab.addEventListener('click', openSheet);
$("#closeSheet").addEventListener('click', closeSheet);
bd.addEventListener('click', closeSheet);

function openSheet(){ bd.classList.add('open'); sheet.classList.add('open'); updateSteps(); }
function closeSheet(){ bd.classList.remove('open'); sheet.classList.remove('open'); updateFab(); }

// Persistencia b√°sica por pesta√±a
function saveCart(){
  sessionStorage.setItem('za_cart_'+slug, JSON.stringify(Array.from(cantidades.entries())));
}
function loadCart(){
  try{
    const raw = JSON.parse(sessionStorage.getItem('za_cart_'+slug)||'[]');
    raw.forEach(([k,v])=>cantidades.set(k,v));
  }catch{}
}
loadCart();

// Entrga/Retiro + direcci√≥n visible solo si Env√≠o
document.querySelectorAll('input[name=envio]').forEach(r=>r.addEventListener('change',()=>{
  $("#addrWrap").style.display = (getEntrega()==='envio') ? 'block' : 'none';
  updateSummary(); updateSteps();
}));

function getEntrega(){
  const c = document.querySelector('input[name=envio]:checked'); return c?c.value:null;
}
function format(n){ return new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(n||0); }

function listItems(){
  const out=[];
  if(!catalog) return out;
  (catalog.categorias||[]).forEach((c,ci)=>{
    (c.productos||[]).forEach((p,pi)=>{
      const id = keyFor(ci,pi);
      const q = (cantidades.get(id)||0);
      if(q>0) out.push({ id, nombre:p.nombre, desc:p.desc||'', precio:Number(p.precio||0), qty:q });
    });
  });
  return out;
}

function parseTip(v){
  v = String(v||'').trim();
  if(!v) return 0;
  if(v.endsWith('%')){
    const pct = Number(v.replace('%','').replace(',','.'))||0;
    return {pct};
  }
  const fixed = Number(v.replace(/[^\d.]/g,''))||0;
  return {fixed};
}

function applyCoupon(code, subtotal, shipping){
  const c = String(code||'').trim().toUpperCase();
  if(!c) return {desc:0, shippingOverride:null};
  if(c==='PIZZA10'){ return {desc: Math.round(subtotal*0.10), shippingOverride:null}; }
  if(c==='NAPO200'){ return {desc: 200, shippingOverride:null}; }
  if(c==='ENVIOFREE'){ return {desc: 0, shippingOverride: 0}; }
  return {desc:0, shippingOverride:null};
}

function calcTotals(){
  const items=listItems();
  let subtotal = items.reduce((a,i)=>a + i.precio*i.qty, 0);
  const entrega = getEntrega();
  let envio = entrega==='envio' ? SHIPPING : 0;

  const cupon = $("#cupon").value;
  const cup = applyCoupon(cupon, subtotal, envio);
  let descuento = cup.desc||0;
  if(cup.shippingOverride!==null) envio = cup.shippingOverride;

  // propina
  const tipRaw = parseTip($("#propina").value);
  let tip = 0;
  if('pct' in tipRaw){ tip = Math.round(subtotal * (tipRaw.pct/100)); }
  if('fixed' in tipRaw){ tip = tipRaw.fixed; }

  const total = Math.max(0, subtotal + envio - descuento + tip);
  return {items, subtotal, envio, descuento, tip, total};
}

function updateSummary(){
  const {items, subtotal, envio, descuento, tip, total} = calcTotals();
  $("#sumLines").innerHTML = items.length? items.map(i=>`<div class="row small"><span>${i.nombre} √ó ${i.qty}</span><span><strong>${format(i.precio*i.qty)}</strong></span></div>`).join('') : '<div class="row small">A√∫n no agregaste productos.</div>';
  $("#subt").textContent = format(subtotal);
  $("#envRow").style.display = envio>0 ? 'flex':'none'; $("#env").textContent = format(envio);
  $("#descRow").style.display = descuento>0 ? 'flex':'none'; $("#desc").textContent = '‚àí '+format(descuento);
  $("#tipRow").style.display = tip>0 ? 'flex':'none'; $("#tip").textContent = format(tip);
  $("#tot").textContent = format(total);
  $("#sumSub").textContent = items.length? '' : '';
  // FAB reflect
  $("#fabTotal").textContent = format(total); $("#fabCount").textContent = String(items.reduce((a,i)=>a+i.qty,0));
}

function updateSteps(){
  const datosOk = $("#nombre").value.trim().length>0 && !!getEntrega() && (getEntrega()==='retiro' || $("#direccion").value.trim().length>0);
  const hay = listItems().length>0;
  steps.forEach(el=>el.classList.remove('active'));
  if(!datosOk){ steps[0].classList.add('active'); }
  else if(datosOk && !hay){ steps[1].classList.add('active'); }
  else { steps[2].classList.add('active'); }
}

["nombre","direccion","nota","cupon","propina"].forEach(id=>{
  const el = document.getElementById(id);
  el.addEventListener('input', ()=>{ updateSummary(); updateSteps(); });
});

document.getElementById('btnVaciar').addEventListener('click',()=>{
  cantidades.clear(); document.querySelectorAll('[id^="q-"]').forEach(s=>s.textContent='0');
  saveCart(); updateSummary(); updateFab();
});

document.getElementById('btnWsp').addEventListener('click',()=>{
  const {items, subtotal, envio, descuento, tip, total} = calcTotals();
  const entrega = getEntrega();
  const name = $("#nombre").value.trim();
  const addr = $("#direccion").value.trim();
  const nota = $("#nota").value.trim();
  if(!name || !entrega || (entrega==='envio' && !addr) || !items.length){ alert('Complet√° los datos y agreg√° productos.'); return; }
  let msg = `Hola, soy ${name}. Quiero hacer un pedido:\n`;
  items.forEach(i=>{ msg += `- ${i.nombre} x${i.qty} - ${format(i.precio*i.qty)}\n`; });
  if(descuento>0) msg += `Descuento: -${format(descuento)}\n`;
  if(entrega==='envio'){ msg += `Env√≠o a domicilio: ${format(envio)}\nDirecci√≥n: ${addr}\n`; } else { msg += `Retiro en el local\n`; }
  if(tip>0) msg += `Propina: ${format(tip)}\n`;
  if(nota) msg += `Nota: ${nota}\n`;
  msg += `Total: ${format(total)}`;
  const num = WSP || '5493416000000';
  window.open(`https://wa.me/${num}?text=${encodeURIComponent(msg)}`,'_blank');
});

// Al iniciar, marcar "Retiro" por defecto y actualizar resumen
document.getElementById('opt-ret').checked = true;
updateSummary(); updateFab(); updateSteps();
</script>
</body>
</html>